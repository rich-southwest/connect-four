<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Connect Four - AI & Online Multiplayer</title>
<script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
min-height: 100vh;
background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
background-size: 400% 400%;
animation: gradient 15s ease infinite;
font-family: 'Arial Black', Arial, sans-serif;
color: white;
display: flex;
justify-content: center;
align-items: center;
}
@keyframes gradient { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

.container {
background: rgba(0,0,0,0.6);
backdrop-filter: blur(12px);
padding: 30px;
border-radius: 25px;
box-shadow: 0 20px 50px rgba(0,0,0,0.6);
text-align: center;
max-width: 500px;
width: 95%;
}

h1 { font-size: 36px; margin-bottom: 30px; text-shadow: 0 0 20px rgba(255,255,255,0.8); }

button {
width: 100%;
padding: 18px;
margin: 12px 0;
font-size: 20px;
font-weight: bold;
border: none;
border-radius: 12px;
cursor: pointer;
transition: all 0.3s;
text-transform: uppercase;
}
button:hover { transform: translateY(-4px); box-shadow: 0 15px 30px rgba(0,0,0,0.4); }

.primary { background: linear-gradient(135deg, #667eea, #764ba2); }
.secondary { background: linear-gradient(135deg, #f093fb, #f5576c); }
.ai-btn { background: linear-gradient(135deg, #11998e, #38ef7d); }

#qr-code { margin: 20px 0; }
#room-link { font-size: 18px; word-break: break-all; margin: 15px 0; background: rgba(0,0,0,0.4); padding: 15px; border-radius: 10px; }

#status { font-size: 28px; margin: 20px 0; min-height: 50px; }

#board {
display: grid;
grid-template-columns: repeat(7, 90px);
grid-template-rows: repeat(6, 90px);
gap: 10px;
background: linear-gradient(145deg, #0f0c29, #302b63);
padding: 20px;
border-radius: 20px;
box-shadow: inset 0 0 40px rgba(0,0,0,0.8);
margin: 20px auto;
}

.cell {
background: radial-gradient(circle at center, #1e3a8a, #1e40af 70%);
border-radius: 50%;
cursor: pointer;
transition: all 0.3s;
box-shadow: inset 0 5px 15px rgba(0,0,0,0.6);
}
.cell:hover { transform: scale(1.08); background: radial-gradient(circle at center, #3b82f6, #60a5fa); }

.disc {
width: 80px;
height: 80px;
border-radius: 50%;
margin: 5px auto;
animation: drop 0.9s cubic-bezier(0.2, 0.8, 0.4, 1);
box-shadow: 0 10px 20px rgba(0,0,0,0.5), inset 0 3px 8px rgba(255,255,255,0.4);
}

.red { background: radial-gradient(circle at 30% 30%, #ff9e9e, #ff416c, #c41e3a); }
.yellow { background: radial-gradient(circle at 30% 30%, #ffff99, #ffe259, #ffa726); }

@keyframes drop {
0% { transform: translateY(-1000px) rotate(0deg); opacity: 0; }
70% { transform: translateY(10px) rotate(360deg); opacity: 1; }
85% { transform: translateY(-5px); }
100% { transform: translateY(0) rotate(720deg); }
}

#back-btn { margin-top: 20px; font-size: 16px; padding: 12px; }

@media (max-width: 600px) {
#board { grid-template-columns: repeat(7, 65px); grid-template-rows: repeat(6, 65px); }
.disc { width: 55px; height: 55px; }
}
</style>
</head>
<body>
<div class="container" id="menu-screen">
<h1>ðŸ”´ Connect Four ðŸŸ¡</h1>
<input type="text" id="player-name" placeholder="Your Name" maxlength="20">
<button id="ai-btn" class="ai-btn">Play vs AI</button>
<button id="create-btn" class="primary">Create Online Game</button>
<button id="join-btn" class="secondary">Join Online Game</button>
</div>

<div class="container" id="join-screen" style="display:none;">
<h1>Join Game</h1>
<input type="text" id="room-id-input" placeholder="Enter Room Code">
<button id="join-confirm" class="primary">Join</button>
<button id="back-menu" class="secondary">Back</button>
</div>

<div class="container" id="room-screen" style="display:none;">
<h1>Room Created!</h1>
<p>Share this link or QR code with your friend:</p>
<div id="room-link"></div>
<div id="qr-code"></div>
<p>Waiting for opponent...</p>
<button id="back-menu2" class="secondary">Cancel</button>
</div>

<div class="container" id="game-screen" style="display:none;">
<div id="player-info"></div>
<div id="status">Your Turn!</div>
<div id="board"></div>
<button id="reset-game" class="secondary">New Game</button>
<button id="back-menu3" class="secondary">Menu</button>
</div>

<script>
const ROWS = 6, COLS = 7;
let board = Array.from({length: ROWS}, () => Array(COLS).fill(0));
let currentPlayer = 1; // 1 red, 2 yellow
let isAI = false;
let isOnline = false;
let peer = null;
let conn = null;
let myName = '';
let oppName = '';
let myTurn = true;

const menuScreen = document.getElementById('menu-screen');
const joinScreen = document.getElementById('join-screen');
const roomScreen = document.getElementById('room-screen');
const gameScreen = document.getElementById('game-screen');
const boardEl = document.getElementById('board');
const statusEl = document.getElementById('status');

document.getElementById('ai-btn').onclick = startAI;
document.getElementById('create-btn').onclick = createRoom;
document.getElementById('join-btn').onclick = () => showScreen(joinScreen);
document.getElementById('join-confirm').onclick = joinRoom;
['back-menu', 'back-menu2', 'back-menu3'].forEach(id => document.getElementById(id).onclick = backToMenu);
document.getElementById('reset-game').onclick = resetGame;

function showScreen(screen) {
[menuScreen, joinScreen, roomScreen, gameScreen].forEach(s => s.style.display = 'none');
screen.style.display = 'block';
}

function backToMenu() {
if (peer) peer.destroy();
showScreen(menuScreen);
resetGame();
}

function startAI() {
myName = document.getElementById('player-name').value.trim() || 'You';
isAI = true; isOnline = false;
currentPlayer = 1; myTurn = true;
showScreen(gameScreen);
initBoard();
updateInfo();
}

function createRoom() {
myName = document.getElementById('player-name').value.trim() || 'Player 1';
peer = new Peer({ config: {'iceServers': [{urls: 'stun:stun.l.google.com:19302'}, {urls: 'stun:stun1.l.google.com:19302'}] } });
peer.on('open', id => {
const url = `${location.href}?room=${id}`;
document.getElementById('room-link').textContent = url;
QRCode.toCanvas(document.getElementById('qr-code'), url, {width: 200});
showScreen(roomScreen);
});
peer.on('connection', c => {
conn = c;
conn.on('open', () => {
conn.send({type: 'name', name: myName});
isOnline = true; myTurn = true; currentPlayer = 1;
initBoard();
updateInfo();
showScreen(gameScreen);
});
conn.on('data', handleData);
});
peer.on('error', err => alert('Error: ' + err.type));
}

function joinRoom() {
const roomId = document.getElementById('room-id-input').value.trim();
if (!roomId) return alert('Enter room code');
myName = document.getElementById('player-name').value.trim() || 'Player 2';
peer = new Peer({ config: {'iceServers': [{urls: 'stun:stun.l.google.com:19302'}, {urls: 'stun:stun1.l.google.com:19302'}] } });
conn = peer.connect(roomId);
conn.on('open', () => {
conn.send({type: 'name', name: myName});
isOnline = true; myTurn = false; currentPlayer = 1;
showScreen(gameScreen);
initBoard();
updateInfo();
});
conn.on('data', handleData);
peer.on('error', err => alert('Connection failed: ' + err.type));
}

function handleData(data) {
if (data.type === 'name') {
oppName = data.name;
updateInfo();
} else if (data.col !== undefined) {
dropInColumn(data.col, data.colPlayer || (myTurn ? 2 : 1));
}
}

function initBoard() {
boardEl.innerHTML = '';
board = Array.from({length: ROWS}, () => Array(COLS).fill(0));
for (let r = 0; r < ROWS; r++) for (let c = 0; c < COLS; c++) {
const cell = document.createElement('div');
cell.classList.add('cell');
cell.dataset.col = c;
cell.onclick = () => playerMove(c);
boardEl.appendChild(cell);
}
}

function playerMove(col) {
if (!myTurn || gameOver()) return;
const row = dropInColumn(col, currentPlayer);
if (row === -1) return;
if (isOnline) conn.send({col});
checkAfterMove();
}

function dropInColumn(col, player) {
for (let r = ROWS-1; r >= 0; r--) {
if (board[r][col] === 0) {
board[r][col] = player;
const cell = boardEl.children[r * COLS + col];
const disc = document.createElement('div');
disc.classList.add('disc', player === 1 ? 'red' : 'yellow');
cell.appendChild(disc);
return r;
}
}
return -1;
}

function checkAfterMove() {
if (checkWin(currentPlayer)) {
statusEl.textContent = `${currentPlayer === 1 ? 'Red' : 'Yellow'} Wins! ðŸŽ‰`;
myTurn = false;
return;
}
if (isDraw()) {
statusEl.textContent = 'Draw!';
return;
}
currentPlayer = 3 - currentPlayer;
myTurn = !myTurn;
updateStatus();
if (isAI && myTurn) setTimeout(aiMove, 800);
}

function updateStatus() {
if (isOnline) {
statusEl.textContent = myTurn ? 'Your Turn!' : `${oppName || 'Opponent'}'s Turn`;
} else {
statusEl.textContent = myTurn ? 'Your Turn!' : 'AI Thinking...';
}
}

function updateInfo() {
document.getElementById('player-info').innerHTML = isOnline ?
`<strong>You (${myName}): ${currentPlayer === 1 ? 'Red' : 'Yellow'}</strong><br>Opponent (${oppName || 'Waiting'}): ${currentPlayer === 1 ? 'Yellow' : 'Red'}` :
`<strong>You: Red</strong> vs <strong>AI: Yellow</strong>`;
}

// Simple but strong AI with minimax depth 6
function aiMove() {
const best = minimax(board, 6, -Infinity, Infinity, true);
dropInColumn(best.col, 2);
checkAfterMove();
}

function minimax(node, depth, alpha, beta, maximizing) {
if (depth === 0 || checkWinAny(node)) return {score: evaluate(node)};
const validCols = getValidCols(node);
if (maximizing) {
let maxEval = {score: -Infinity};
for (let col of validCols) {
const child = copyBoard(node);
dropInColumnBoard(child, col, 2);
const eval = minimax(child, depth-1, alpha, beta, false);
if (eval.score > maxEval.score) maxEval = {score: eval.score, col};
alpha = Math.max(alpha, eval.score);
if (beta <= alpha) break;
}
return maxEval;
} else {
let minEval = {score: Infinity};
for (let col of validCols) {
const child = copyBoard(node);
dropInColumnBoard(child, col, 1);
const eval = minimax(child, depth-1, alpha, beta, true);
if (eval.score < minEval.score) minEval = {score: eval.score, col};
beta = Math.min(beta, eval.score);
if (beta <= alpha) break;
}
return minEval;
}
}

function evaluate(b) {
let score = 0;
// Center preference
for (let r = 0; r < ROWS; r++) if (b[r][3] === 2) score += 3;
// Win check
if (checkWinAny(b) === 2) return 100000;
if (checkWinAny(b) === 1) return -100000;
return score;
}

function checkWinAny(b) {
// Horizontal, vertical, diagonals
for (let r = 0; r < ROWS; r++) for (let c = 0; c < COLS; c++) {
const p = b[r][c];
if (p === 0) continue;
if (c <= COLS-4 && p === b[r][c+1] && p === b[r][c+2] && p === b[r][c+3]) return p;
if (r <= ROWS-4 && p === b[r+1][c] && p === b[r+2][c] && p === b[r+3][c]) return p;
if (r <= ROWS-4 && c <= COLS-4 && p === b[r+1][c+1] && p === b[r+2][c+2] && p === b[r+3][c+3]) return p;
if (r <= ROWS-4 && c >= 3 && p === b[r+1][c-1] && p === b[r+2][c-2] && p === b[r+3][c-3]) return p;
}
return 0;
}

function getValidCols(b) {
const cols = [];
for (let c = 0; c < COLS; c++) if (b[0][c] === 0) cols.push(c);
return cols;
}

function copyBoard(b) { return b.map(row => row.slice()); }

function dropInColumnBoard(b, col, player) {
for (let r = ROWS-1; r >= 0; r--) if (b[r][col] === 0) { b[r][col] = player; return; }
}

function checkWin(player) { return checkWinAny(board) === player; }
function isDraw() { return board[0].every(c => c !== 0); }
function gameOver() { return checkWinAny(board) || isDraw(); }

function resetGame() {
initBoard();
currentPlayer = 1;
myTurn = isOnline ? true : true; // host starts
updateStatus();
updateInfo();
}

// Extract room from URL for direct join
const urlParams = new URLSearchParams(location.search);
if (urlParams.has('room')) {
document.getElementById('room-id-input').value = urlParams.get('room');
joinRoom();
}

document.getElementById('player-name').focus();
</script>
</body>
</html>
